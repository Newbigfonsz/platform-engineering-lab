name: CI/CD Pipeline - TaskApp

on:
  push:
    branches: [ main ]
    paths:
      - 'manifests/**'
      - '.github/workflows/cicd-taskapp.yaml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'manifests/'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Check for secrets (non-blocking)
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: main
          head: HEAD

  validate:
    name: Validate Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          rm kubeval-linux-amd64.tar.gz

      - name: Validate Kubernetes manifests
        run: |
          echo "ğŸ” Validating Kubernetes manifests..."
          for file in manifests/*.yaml; do
            echo "âœ“ Validating $file"
            kubeval "$file" || true
          done

      - name: Check for placeholder passwords
        run: |
          echo "ğŸ” Checking for placeholder passwords..."
          if grep -r "CHANGE_ME_IN_PRODUCTION" manifests/; then
            echo "âœ… Placeholders found (good!)"
          fi
          
          if grep -r "SecurePassword\|Admin2026\|Megan2026" manifests/ 2>/dev/null; then
            echo "âŒ ERROR: Real passwords in manifests!"
            exit 1
          fi
          
          echo "âœ… No real passwords found"

  gitops-sync:
    name: GitOps Auto-Deployment
    runs-on: ubuntu-latest
    needs: [security-scan, validate]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: GitOps notification
        run: |
          echo "âœ… Changes validated and pushed to main branch"
          echo ""
          echo "ğŸ”„ ArgoCD will automatically detect and deploy changes"
          echo ""
          echo "ğŸ“Š Monitor deployment:"
          echo "   â€¢ ArgoCD UI: https://argocd.alphonzojonesjr.com"
          echo "   â€¢ Application: https://taskapp.alphonzojonesjr.com"
          echo "   â€¢ Grafana: https://grafana.alphonzojonesjr.com"
          echo ""
          echo "â±ï¸ ArgoCD sync interval: ~3 minutes"

  notify:
    name: Pipeline Status
    runs-on: ubuntu-latest
    needs: [security-scan, validate, gitops-sync]
    if: always()
    steps:
      - name: Report status
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       CI/CD PIPELINE COMPLETE              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ "${{ needs.security-scan.result }}" == "success" ] && \
             [ "${{ needs.validate.result }}" == "success" ]; then
            echo "âœ… All checks passed!"
            echo "ğŸš€ ArgoCD will deploy automatically"
          else
            echo "âŒ Pipeline failed - check errors above"
            exit 1
          fi
