name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-yaml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install yamllint
        run: pip install yamllint
        
      - name: Lint YAML files
        run: yamllint -d relaxed apps/ argocd/ || true

  validate-manifests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        
      - name: Validate Kubernetes manifests
        run: |
          for file in $(find apps -name "*.yaml" -o -name "*.yml"); do
            echo "Validating $file"
            kubectl apply --dry-run=client -f "$file" 2>/dev/null || echo "Skipped: $file"
          done

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'

  terraform-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        
      - name: Terraform Format Check
        run: |
          cd terraform/proxmox
          terraform fmt -check -recursive || true

  notify-success:
    needs: [lint-yaml, validate-manifests, security-scan, terraform-validate]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Pipeline Success
        run: |
          echo "âœ… All checks passed!"
          echo "ArgoCD will auto-sync changes to the cluster"
